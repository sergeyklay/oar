---
description: Enforce Node.js 24 environment and package manager rules via nvm.
globs: **/*
alwaysApply: true
---

# Environment & Runtime Constraints

**CRITICAL:** This project requires **Node.js 24+**.

The system environment might default to an older version. You MUST ensure the correct version is active before running commands.

## Terminal Command Execution Rules

**Context:** You are running in an interactive VS Code terminal. The environment is likely already loaded. If not, you must load it using `nvm use` once. You should never need to run `nvm use` more than once.

**Rule:** DO NOT blindly chain `source ~/.nvm/nvm.sh` or `export` commands. It creates messy, fragile commands.

**Execution Flow:**
1.  **Assume Success:** Try running the command simply first (e.g., `npm install rrule`).
2.  **Verify only on Error:** If and ONLY IF you get a "command not found" or "incompatible engine" error, THEN try to fix the environment using `nvm use 24`.
3.  **Clean Commands:** Your output should look like user input.
    * ✅ `npm run db:push`
    * ❌ `cd /home/... && source ... && nvm use && npm run db:push`

## Package Manager

- **ONLY use `npm`** - `yarn`, `pnpm`, `bun` or any other package manager are forbidden to prevent lockfile conflicts.
- **Lock file committed** - `package-lock.json` must be in version control and never ignored.
- **CI Integrity** - Use `npm ci` for clean, reproducible installs in pipelines or fresh setups.
- **Segregation** - Strictly separate `dependencies` (prod) from `devDependencies` (build/test/lint).
- **Respect `.nvmrc` at the project root** - This file defines the recommended Node.js version for the project.

### Dependency Resolution Strategy (Error Handling)

If you encounter `npm error code ERESOLVE` (Peer Dependency Conflict):

1.  **Analyze:** Is the conflict caused by a bleeding-edge framework (e.g., Next.js Canary)?
2.  **Action:** You are **AUTHORIZED** to retry the command with `--legacy-peer-deps`.
    * *Example:* `npm install --legacy-peer-deps`
3.  **Stable First:** Unless the user explicitly asks for "Canary" or "Beta" features, always prefer `@latest` stable versions for `create-next-app` and libraries to minimize conflicts.

## Essential Commands

~~~bash
# ✅ DO: Correct nvm usage
nvm use 24

# ✅ DO: Check version if unsure
node -v

# ✅ DO: Simple commands
npm run dev                        # Run development server
npx drizzle-kit generate           # Generate migration files
npx drizzle-kit push --force       # Push schema changes to SQLite

# ✅ DO: Correct npm usage
npm install package-name           # Add new dependency (updates lockfile)
npm install -D package-name        # Add development dependency
npm ci                             # Clean install from lockfile (Strict)
npm run script-name                # Run scripts defined in package.json
npx tool-name                      # Run binaries without global install
npm audit fix                      # Fix security vulnerabilities

# ❌ DON'T: Forbidden actions
yarn add package-name              # Never mix package managers
npm install -g package-name        # Avoid global installs (use npx or devDeps)
rm -rf node_modules                # Use 'npm ci' instead of manual cleaning
# Manually editing package-lock.json
~~~

## Quick Reference

~~~bash
# Add production dependency
npm install axios

# Add development/testing dependency
npm install -D jest typescript

# specific version
npm install react@18.2.0

# Install dependencies for an existing project (Best Practice)
npm ci

# Update minor/patch versions based on package.json constraints
npm update
~~~

## Critical Rules

- **NEVER use Yarn/PNPM** - npm only in this project.
- **Commit package-lock.json** - Always version control the lock file; do not add to .gitignore.
- **Prefer `npm ci`** - When setting up the repo or in CI/CD, use `ci` to ensure you get exactly what is in the lockfile.
- **Audit Regularly** - Run `npm audit` when adding major dependencies.
- **Prefer Stable** - Default to stable versions. If forced to use Canary, handle peer deps gracefully.
