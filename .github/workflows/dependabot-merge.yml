name: Dependabot auto-merge

on:
  workflow_run:
    workflows: [CI]
    types:
      - completed

permissions:
  contents: write
  pull-requests: write

jobs:
  dependabot:
    name: Auto-approve and merge
    runs-on: ubuntu-latest

    # Only run if:
    # 1. The CI workflow was triggered by a PR (not a direct push)
    # 2. The triggering user is Dependabot
    if: >
      github.event.workflow_run.event == 'pull_request' &&
      github.event.workflow_run.actor.login == 'dependabot[bot]'

    steps:
      - name: Get Pull Request info
        id: pr
        uses: actions/github-script@v8
        with:
          script: |
            const { data: pullRequests } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${context.repo.owner}:${context.payload.workflow_run.head_branch}`
            });

            if (pullRequests.length === 0) {
              core.setFailed('No open PR found for this workflow run');
              return;
            }

            const pr = pullRequests[0];
            core.setOutput('number', pr.number);
            core.setOutput('url', pr.html_url);
            core.setOutput('mergeable', pr.mergeable);
            core.setOutput('mergeable_state', pr.mergeable_state);

            console.log(`PR #${pr.number}: mergeable=${pr.mergeable}, state=${pr.mergeable_state}`);

      - name: Check CI conclusion
        if: github.event.workflow_run.conclusion != 'success'
        run: |
          echo "::error::CI workflow did not succeed (conclusion: ${{ github.event.workflow_run.conclusion }})"
          echo "Skipping approval and auto-merge."
          exit 1

      - name: Check merge state
        id: merge-check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
          PR_NUMBER: ${{ steps.pr.outputs.number }}
        run: |
          # Get detailed PR info including mergeable state
          # mergeStateStatus values: BEHIND, BLOCKED, CLEAN, DIRTY, DRAFT, HAS_HOOKS, UNKNOWN, UNSTABLE
          PR_DATA=$(gh pr view "$PR_NUMBER" --repo "$GH_REPO" --json mergeable,mergeStateStatus)
          MERGEABLE=$(echo "$PR_DATA" | jq -r '.mergeable')
          MERGE_STATE=$(echo "$PR_DATA" | jq -r '.mergeStateStatus')

          echo "Mergeable: $MERGEABLE"
          echo "Merge State: $MERGE_STATE"

          # DIRTY = merge conflict, BEHIND = out-of-date with base branch
          # Both cases require a rebase before we can merge
          if [ "$MERGEABLE" = "CONFLICTING" ] || [ "$MERGE_STATE" = "DIRTY" ] || [ "$MERGE_STATE" = "BEHIND" ]; then
            echo "needs_rebase=true" >> "$GITHUB_OUTPUT"
            echo "reason=$MERGE_STATE" >> "$GITHUB_OUTPUT"
          else
            echo "needs_rebase=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Request rebase
        if: steps.merge-check.outputs.needs_rebase == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
          PR_NUMBER: ${{ steps.pr.outputs.number }}
          REASON: ${{ steps.merge-check.outputs.reason }}
        run: |
          echo "Branch needs rebase (reason: $REASON). Requesting Dependabot to rebase..."
          gh pr comment "$PR_NUMBER" --repo "$GH_REPO" --body "@dependabot rebase"
          echo "::warning::Requested @dependabot rebase (reason: $REASON)"
          exit 0

      - name: Approve Pull Request
        if: steps.merge-check.outputs.needs_rebase != 'true'
        env:
          GH_TOKEN: ${{ secrets.CICDBOT_TOKEN }}
          GH_REPO: ${{ github.repository }}
          PR_NUMBER: ${{ steps.pr.outputs.number }}
        run: |
          echo "Approving PR #$PR_NUMBER"
          gh pr review "$PR_NUMBER" --repo "$GH_REPO" --approve --body "ðŸ¤– Auto-approved by @cicdbot after CI passed"

      - name: Enable auto-merge
        if: steps.merge-check.outputs.needs_rebase != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
          PR_NUMBER: ${{ steps.pr.outputs.number }}
        run: |
          echo "Enabling auto-merge for PR #$PR_NUMBER"
          gh pr merge "$PR_NUMBER" --repo "$GH_REPO" --auto --squash
