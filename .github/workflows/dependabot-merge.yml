name: Dependabot auto-merge

on:
  workflow_run:
    workflows: [CI]
    types:
      - completed

permissions:
  contents: write
  pull-requests: write

jobs:
  dependabot:
    name: Auto-approve and merge
    runs-on: ubuntu-latest

    # Only run if:
    # 1. The CI workflow was triggered by a PR (not a direct push)
    # 2. The triggering user is Dependabot
    if: >
      github.event.workflow_run.event == 'pull_request' &&
      github.event.workflow_run.actor.login == 'dependabot[bot]'

    steps:
      - name: Get Pull Request info
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pullRequests } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${context.repo.owner}:${context.payload.workflow_run.head_branch}`
            });

            if (pullRequests.length === 0) {
              core.setFailed('No open PR found for this workflow run');
              return;
            }

            const pr = pullRequests[0];
            core.setOutput('number', pr.number);
            core.setOutput('url', pr.html_url);
            core.setOutput('mergeable', pr.mergeable);
            core.setOutput('mergeable_state', pr.mergeable_state);

            console.log(`PR #${pr.number}: mergeable=${pr.mergeable}, state=${pr.mergeable_state}`);

      - name: Check CI conclusion
        if: github.event.workflow_run.conclusion != 'success'
        run: |
          echo "::error::CI workflow did not succeed (conclusion: ${{ github.event.workflow_run.conclusion }})"
          echo "Skipping approval and auto-merge."
          exit 1

      - name: Check for merge conflicts
        id: conflict-check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ steps.pr.outputs.number }}
        run: |
          # Get detailed PR info including mergeable state
          PR_DATA=$(gh pr view "$PR_NUMBER" --json mergeable,mergeStateStatus)
          MERGEABLE=$(echo "$PR_DATA" | jq -r '.mergeable')
          MERGE_STATE=$(echo "$PR_DATA" | jq -r '.mergeStateStatus')

          echo "Mergeable: $MERGEABLE"
          echo "Merge State: $MERGE_STATE"

          if [ "$MERGEABLE" = "CONFLICTING" ] || [ "$MERGE_STATE" = "DIRTY" ]; then
            echo "has_conflict=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_conflict=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Request rebase if conflicts exist
        if: steps.conflict-check.outputs.has_conflict == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ steps.pr.outputs.number }}
        run: |
          echo "Merge conflict detected. Requesting Dependabot to rebase..."
          gh pr comment "$PR_NUMBER" --body "@dependabot rebase"
          echo "::warning::Merge conflict detected. Requested @dependabot rebase."
          exit 0

      - name: Approve Pull Request
        if: steps.conflict-check.outputs.has_conflict != 'true'
        env:
          PR_URL: ${{ steps.pr.outputs.url }}
          GH_TOKEN: ${{ secrets.CICDBOT_TOKEN }}
        run: |
          echo "Approving PR: $PR_URL"
          gh pr review "$PR_URL" --approve --body "ðŸ¤– Auto-approved by @cicdbot after CI passed"

      - name: Enable auto-merge
        if: steps.conflict-check.outputs.has_conflict != 'true'
        env:
          PR_URL: ${{ steps.pr.outputs.url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Enabling auto-merge for PR: $PR_URL"
          gh pr merge --auto --squash "$PR_URL"
